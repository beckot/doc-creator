name: Deploy PWA to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin v3.82.13
          trufflehog --version

      - name: Select TruffleHog base ref
        id: trufflehog-base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          else
            # On pushes, scan the diff against the previous commit to avoid HEAD==BASE failures.
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              echo "base_sha=$(git rev-parse HEAD^)" >> "$GITHUB_OUTPUT"
            else
              echo "base_sha=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Scan for secrets with TruffleHog
        run: |
          BASE_SHA="${{ steps.trufflehog-base.outputs.base_sha }}"
          if [ -n "$BASE_SHA" ]; then
            trufflehog git file://. \
              --since-commit="$BASE_SHA" \
              --branch=HEAD \
              --only-verified \
              --exclude-paths .trufflehogignore \
              --fail
          else
            echo "Skipping TruffleHog diff scan (no base commit)"
          fi

      - name: Scan for API keys and tokens
        run: |
          echo "Scanning for potential secrets..."
          # Search for common secret patterns (excluding variable names like 'token' or 'tokens').
          # Skip minified third-party libraries (e.g., Mermaid bundle) that trigger false positives.
          # Known false positive: pwa/libs/mermaid.min.js (minified Mermaid vendor bundle)
          if grep -rE "(api[_-]?key\s*[:=]|secret\s*[:=]|password\s*[:=]|['\"]token['\"]?\s*[:=]|private[_-]?key\s*[:=]|credential\s*[:=])" \
            --include="*.js" --include="*.html" --include="*.json" --exclude-dir="libs" ./pwa/ 2>/dev/null; then
            echo "❌ WARNING: Potential secrets found in code"
            exit 1
          fi
          echo "✅ No obvious secrets detected"
      
      - name: Check for sensitive file patterns
        run: |
          echo "Checking for sensitive files..."
          if find ./pwa -name "*.env*" -o -name "*secret*" -o -name "*password*" -o -name "*.pem" -o -name "*.key" 2>/dev/null | grep -q .; then
            echo "❌ WARNING: Sensitive files detected"
            exit 1
          fi
          echo "✅ No sensitive files found"
      
      - name: Validate PWA has no backend calls
        run: |
          echo "Scanning for backend/server connections..."
          if grep -rE "(fetch\(|XMLHttpRequest|\.post\(|\.get\(|axios)" --include="*.js" ./pwa/ 2>/dev/null | grep -vE "(localhost|127\.0\.0\.1|cdn\.|jsdelivr\.net)"; then
            echo "⚠️  External API calls detected - verify these are intentional"
          fi
          echo "✅ Security scan complete"

  deploy:
    needs: security-scan
    if: github.event_name == 'push'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './pwa'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
